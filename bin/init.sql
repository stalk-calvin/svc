
-- POSSIBLE tampering safeguard
-- ALLOW only INSERT (No DELETE/UPDATE on audit logs)

--CREATE RULE audit_log_protect AS
--ON UPDATE TO audit_log
--DO INSTEAD NOTHING;

--CREATE RULE audit_log_no_delete AS
--ON DELETE TO audit_log
--DO INSTEAD NOTHING;

-- Create user_acl table if it doesn't exist
CREATE TABLE IF NOT EXISTS user_acl (
    is_admin boolean not null,
    id bigint generated by default as identity,
    user_id varchar(255),
    primary key (id)
);

-- Create user_acl_allowed_entities table if it doesn't exist
CREATE TABLE IF NOT EXISTS user_acl_allowed_entities (
    id bigint generated by default as identity,
    user_acl_id bigint not null,
    allowed_entity varchar(255),
    primary key (id)
);

-- Insert admin user
INSERT INTO user_acl (id, is_admin, user_id)
VALUES (1, true, 'admin-user-id')
ON CONFLICT (id) DO NOTHING;

-- Insert non-admin user
INSERT INTO user_acl (id, is_admin, user_id)
VALUES (2, false, 'non-admin-user-id')
ON CONFLICT (id) DO NOTHING;

-- Insert allowed entities for non-admin user
INSERT INTO user_acl_allowed_entities (user_acl_id, allowed_entity)
VALUES
    (2, 'UserProfile'),
    (2, 'User')
ON CONFLICT (id) DO NOTHING;